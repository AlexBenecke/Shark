---
title: "Data Prep"
author: "Alex Benecke"
date: "July 30, 2018"
output:  
  html_document: 
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 4
    fig_width: 8
    fig_height: 6
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Packages, include=FALSE}
require(FSA)
require(tidyverse)
require(dplyr)
require(magrittr)
require(scales)

source("5_functions/dropbox_fn.R") # For interacting with dropbox
proj = "shark" # Specify project where data is stored 
output_data_prep <- path_get(proj, "output/output_data_prep")

source("5_functions/taxa-function.R")
```

## Data Exploration ##

### Hist plots


## Creating New Variables ##

```{r Load CPUE data}
eff <- read_csv_fn(proj, "data/raw-data/CPUE.csv", na.strings = "") %>%
  arrange(YEAR,GOM_AREA,END_GMT)

str(eff)
headtail(eff)
```


### AVG.DEPTH

```{r Create AVG.DEPTH}
### Find STARTDEPTH and ENDDEPTH Variables

head(eff[,c(8,12)])

### Average STARTDEPTH and ENDDEPTH and save as AVG.DEPTH

eff$AVG.DEPTH <- apply(eff[,c(8,12)], 1, FUN=mean) 

range(eff$AVG.DEPTH, na.rm = TRUE)
```

### Month
```{r Create Month Variable }

head(eff$START_GMT)

str(eff$START_GMT)
### Format START_GMT as Date

eff$START_GMT <- strptime(eff$START_GMT, format = "%m/%d/%Y")

str(eff$START_GMT)

eff$MONTH <- format.Date(eff$START_GMT, format = "%m")

str(eff$MONTH)
```


### Distance to shore

```{r Load packages needed to create distance to shore variable, eval=FALSE}
require(rgdal)   # for readOGR(...); loads package sp as well
require(rgeos)   # for gDistance(...)


require(parallel) # for detect cores
require(foreach)   # for foreach(...)
require(snow)      # for makeCluster(...)
require(doSNOW)    # for resisterDoSNOW(...)
```


```{r Distance to Shore Variable, eval=FALSE}
eff$Long <- eff$STARTLON
eff$Lat <- eff$STARTLAT

head(eff)
str(eff)

wgs.84    <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
mollweide <- "+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
sp.points <- SpatialPoints(eff[,c("Long","Lat")], proj4string=CRS(wgs.84))

path <- "shape-file/ne_10m_coastline/ne_10m_coastline.shp"

coast  <- rgdal::readOGR(dsn = path,layer="ne_10m_coastline",p4s=wgs.84)

coast.moll <- spTransform(coast,CRS(mollweide))

point.moll <- spTransform(sp.points,CRS(mollweide))

no_cores <- detectCores()

cl <- makeCluster(no_cores,type="SOCK")  # create a 4-processor cluster
registerDoSNOW(cl)                # register the cluster

get.dist.parallel <- function(n) {
  foreach(i=1:n, .combine=c, .packages="rgeos", .inorder=TRUE, 
          .export=c("point.moll","coast.moll")) %dopar% gDistance(point.moll[i],coast.moll)
}

eff$Dis.to.SHORE <- get.dist.parallel(length(sp.points))

eff$Dis.to.SHORE <- eff$Dis.to.SHORE/1000

head(eff)
str(eff)
```


```{r Plot points and shoreline, echo = FALSE}

gulf.shape <- "shape-file/Shape/stateshigh.shp"
gulf.shape <- maptools::readShapePoly(gulf.shape)

plot(eff$Long, eff$Lat,
     xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
     xlab ="Longitude", ylab = "Latitude",
     pch = 19)
par(new=T)
sp::plot(gulf.shape, add= T,
         xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
         col = "gray")

```


### Create Presence Abscence Variable

This has been put inside the extract taxa finction (`taxa-fn.R`).

```{r Create pres variable, eval=FALSE}
extract_taxa_fn <- function(data.in = x,
                                tax.id = y) {
  
  red.df <- data.in %>%
    select(YEAR, MONTH, STARTLAT, STARTLON, START_GMT, ENDLAT, ENDLON, 
           STARTDEPTH, ENDDEPTH, AVG.DEPTH, TEMPBOTM, FLUOROBOTM, TURBBOTM, 
           OXYBOTM, SALBOTM, dombot8, dombot4, Dis.to.SHORE)
  
  red.df <- cbind(red.df, cpe = tax.id) 
  
  pos.ind <- which(red.df$cpe >= 0)   ### be sure no negatives
  red.df <- red.df[pos.ind,]
  
  ### Create presence absence variable
  
  red.df$pres <- numeric(nrow(red.df))
  
  for(i in 1:nrow(red.df)){
    
    if(red.df$cpe[i] > 0){
      
      red.df$pres[i] <- 1
      
    } else if(red.df$cpe[i] == 0){
      
      red.df$pres[i] <- 0
      
    } else{
      
      red.df$pres[i] <- "NA"
      
    }
  }
  
  
  red.df %<>% select(cpe, pres, DATE = START_GMT, YEAR, MONTH, STARTLAT:STARTLON, ENDLAT:ENDLON, 
                     STARTDEPTH, ENDDEPTH, AVG.DEPTH, TEMPBOTM:dombot4, Dis.to.SHORE)
  
  
  return(reduced.df = red.df)
}
```


### Saving changes to CPUE2.csv 

```{r Create CPUE2.csv, }

#8-1-18#write_csv_fn(proj, eff, file = "data/raw-data/CPUE2.csv", row.names = FALSE)

```


## QA/QC ##


1. Load CPUE2.csv data, Extract CPUE for all species and save in a list called sp.df

```{r Load Data}
source("5_functions/taxa-function.R")

eff2 <- read_csv_fn(proj, "data/raw-data/CPUE2.csv") 

str(eff2)

sp.df <- list(blacknose =  extract_taxa_fn(eff2,
                                   eff2$CARCHARHINUS.ACRONOTUS),
              
              blacktip = extract_taxa_fn(eff2,
                                     eff2$CARCHARHINUS.LIMBATUS),
              
              bull = extract_taxa_fn(eff2,
                                     eff2$CARCHARHINUS.LEUCAS),
              
              sandbar = extract_taxa_fn(eff2,
                                     eff2$CARCHARHINUS.PLUMBEUS),
              
              sharpnose = extract_taxa_fn(eff2,
                                     eff2$RHIZOPRIONODON.TERRAENOVAE),
              
              silky = extract_taxa_fn(eff2,
                                     eff2$CARCHARHINUS.FALCIFORMIS),
              
              spinner = extract_taxa_fn(eff2,
                                    eff2$CARCHARHINUS.BREVIPINNA),
              
              tiger = extract_taxa_fn(eff2,
                                     eff2$GALEOCERDO.CUVIER))

str(sp.df$sharpnose)
head(sp.df$sharpnose)
```

2. Plot CPUE for all Species vs all Explanatory variables

```{r Plot cpe vs all vars, echo = FALSE}
for(i in 1:length(sp.df)){
  
  oldpar <- par(mfrow=c(3,4), mar=c(5,4,2,1), oma=c(1,0,3,1))
  
  plot(cpe~YEAR,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$YEAR, sp.df[[i]]$cpe)),
        side=3,line=0)
  
  plot(cpe~MONTH,
       data = sp.df[[i]])
  
  plot(cpe~AVG.DEPTH,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$AVG.DEPTH, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~SALBOTM,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$SALBOTM, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~TEMPBOTM,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$TEMPBOTM, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~FLUOROBOTM,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$FLUOROBOTM, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~TURBBOTM,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$TURBBOTM, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~OXYBOTM,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$OXYBOTM, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~dombot8,
       data = sp.df[[i]],
       xlab="", las=2)
  
  plot(cpe~Dis.to.SHORE,
       data = sp.df[[i]],
       las=2)
    mtext(paste0("r = ",
               cor(sp.df[[i]]$Dis.to.SHORE, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)

  plot(cpe~STARTLAT,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$STARTLAT, sp.df[[i]]$cpe)),
        side=3,line=0)
  
  plot(cpe~STARTLON,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$STARTLON, sp.df[[i]]$cpe)),
        side=3,line=0)
  
  mtext(names(sp.df[i]), side=3, line=0.65, outer=TRUE, cex=2, 
        font=2)
  
  par(oldpar)
}
```


3. Identify outliers

```{r QAQC}
### QA QC

par(mfrow=c(1,1))
plot(eff2$STARTLON,eff2$STARTLAT)


summary(eff2[c(6:8,12,38:50)])

#### outlier notes

plot(eff2$SALBOTM, eff2$CARCHARHINUS.ACRONOTUS)


range(eff2$SALBOTM, na.rm = TRUE)

(rm.Sal <- which(eff2$SALBOTM > 40 | eff2$SALBOTM < 15)) ### 507  932 2705 2770 2771 2941 2979

eff2[c(rm.Sal),c(1,42)]

#(rm.EndLon <- which(eff2$ENDLON > -80)) ### 1465 >>> just always use STARTLON and STARTLAT


range(eff2$OXYBOTM, na.rm = TRUE)

(oxy <- which(eff2$OXYBOTM == 0))

eff2[c(oxy),]


(rm.Oxy <- which(eff2$OXYBOTM > 12 | eff2$OXYBOTM == 0)) ### 99 100 338 339 411 625 652 823 824 

eff2[c(rm.Oxy),c(1,41,43:50)]


 ### TURBBOTM and FLUOROBOTM are not used as explanitory variables so there is no need to remove outliers

plot(eff2$TURBBOTM, eff2$CARCHARHINUS.ACRONOTUS)

range(eff2$TURBBOTM , na.rm=T)

(rm.Turb <- which(eff2$TURBBOTM > 100 | eff2$TURBBOTM <= 0)) ### 1994

eff2[c(rm.Turb),]

#(rm.Fluo <-which(eff2$FLUOROBOTM > 30)) ### 1536, 1802, 2230, 2660, 2704


(n.rm <- length(rm.Sal) + length(rm.Oxy) + length(rm.Turb))

```

4. remove outliers and create individual data frames for each species save as .csv file

```{r Create sp.df, eval = FALSE}


  ### round 1 ###rm.EndLon
(rm1 <- c(rm.Sal,rm.Oxy, rm.Turb) %>%
   sort())

### round 2
#(rm2 <- c(rm.Oxy, rm.Turb, rm.Fluo))




eff2 <- eff2[-c(rm1),]
######

str(eff2)
#write.csv(eff2,"data/CPUE3.csv", row.names = FALSE)

(sp.list <- colnames(eff2[,c(43:50)]))

##  which(names(eff) %in%  (sp.list <- colnames(eff[,c(43:50)])) )
```




```{r Extract CPUE for each species and create .csv, eval = FALSE}
### CARCHARHINUS.ACRONOTUS

blacknose <- extract_taxa_fn(eff2,
                             eff2$CARCHARHINUS.ACRONOTUS) %>%
#  write_csv_fn(proj, file = "data/clean-data/blacknose.csv", row.names = FALSE)


### CARCHARHINUS.BREVIPINNA

spinner <- extract_taxa_fn(eff2,
                                    eff2$CARCHARHINUS.BREVIPINNA) %>%
#  write_csv_fn(proj, file = "data/clean-data/spinner.csv", row.names = FALSE)



### CARCHARHINUS.FALCIFORMIS

silky <- extract_taxa_fn(eff2,
                                     eff2$CARCHARHINUS.FALCIFORMIS) %>%
#  write_csv_fn(proj, file = "data/clean-data/silky.csv", row.names = FALSE)



### CARCHARHINUS.LEUCAS

bull <- extract_taxa_fn(eff2,
                                     eff2$CARCHARHINUS.LEUCAS) %>%
#  write_csv_fn(proj, file = "data/clean-data/bull.csv", row.names = FALSE)



### CARCHARHINUS.LIMBATUS

blacktip <- extract_taxa_fn(eff2,
                                     eff2$CARCHARHINUS.LIMBATUS) %>%
#  write_csv_fn(proj, file = "data/clean-data/blacktip.csv", row.names = FALSE)



### CARCHARHINUS.PLUMBEUS

sandbar <- extract_taxa_fn(eff2,
                                     eff2$CARCHARHINUS.PLUMBEUS) %>%
#  write_csv_fn(proj, file = "data/clean-data/sandbar.csv", row.names = FALSE)



### GALEOCERDO.CUVIER

tiger <- extract_taxa_fn(eff2,
                                     eff2$GALEOCERDO.CUVIER) %>%
#  write_csv_fn(proj, file = "data/clean-data/tiger.csv", row.names = FALSE)



### RHIZOPRIONODON.TERRAENOVAE

sharpnose <- extract_taxa_fn(eff2,
                                     eff2$RHIZOPRIONODON.TERRAENOVAE) %>%
#  write_csv_fn(proj, file = "data/clean-data/sharpnose.csv", row.names = FALSE)

```

5. Load newly created .csv files and save to sp.df list

```{r}
sp.df <- list(blacknose = read_csv_fn(proj, "data/clean-data/blacknose.csv"),
              blacktip = read_csv_fn(proj, "data/clean-data/blacktip.csv"),
              bull = read_csv_fn(proj, "data/clean-data/bull.csv"),
              sandbar = read_csv_fn(proj, "data/clean-data/sandbar.csv"),
              sharpnose = read_csv_fn(proj, "data/clean-data/sharpnose.csv"),
              silky = read_csv_fn(proj, "data/clean-data/silky.csv"),
              spinner = read_csv_fn(proj, "data/clean-data/spinner.csv"),
              tiger = read_csv_fn(proj, "data/clean-data/tiger.csv"))
```

6. make new cpue plots and make sure outliers are gone.

```{r New Plot cpe vs all vars, echo=FALSE}
for(i in 1:length(sp.df)){
  
  oldpar <- par(mfrow=c(3,4), mar=c(5,4,2,1), oma=c(1,0,3,1))
  
  plot(cpe~YEAR,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$YEAR, sp.df[[i]]$cpe)),
        side=3,line=0)
  
  plot(cpe~MONTH,
       data = sp.df[[i]])
  
  plot(cpe~AVG.DEPTH,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$AVG.DEPTH, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~SALBOTM,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$SALBOTM, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~TEMPBOTM,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$TEMPBOTM, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~FLUOROBOTM,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$FLUOROBOTM, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~TURBBOTM,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$TURBBOTM, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~OXYBOTM,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$OXYBOTM, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)
  
  plot(cpe~dombot8,
       data = sp.df[[i]],
       xlab="", las=2)
  
  plot(cpe~Dis.to.SHORE,
       data = sp.df[[i]],
       las=2)
    mtext(paste0("r = ",
               cor(sp.df[[i]]$Dis.to.SHORE, sp.df[[i]]$cpe, use = "complete.obs")),
        side=3,line=0)

  plot(cpe~STARTLAT,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$STARTLAT, sp.df[[i]]$cpe)),
        side=3,line=0)
  
  plot(cpe~STARTLON,
       data = sp.df[[i]])
  mtext(paste0("r = ",
               cor(sp.df[[i]]$STARTLON, sp.df[[i]]$cpe)),
        side=3,line=0)
  
  mtext(names(sp.df[i]), side=3, line=0.65, outer=TRUE, cex=2, 
        font=2)
  
  par(oldpar)
}
```


