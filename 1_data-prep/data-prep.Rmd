---
title: "Data Prep"
author: "Alex Benecke"
date: "July 30, 2018"
output:  
  html_document: 
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 4
    fig_width: 10
    fig_height: 8
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Packages, include=FALSE}
require(FSA)
require(tidyverse)
require(dplyr)
require(magrittr)
require(scales)

source("5_functions/dropbox_fn.R") # For interacting with dropbox
proj = "shark" # Specify project where data is stored 
output_data_prep <- path_get(proj, "output/output_data_prep")

#source("5_functions/taxa-function.R") # DEFUNKT
```

## Data Exploration ##

### Hist plots


## Creating New Variables ##

```{r Load CPUE data}
eff <- read_csv_fn( "data/raw-data/CPUE.csv", proj) %>%
  arrange(year)

str(eff)
headtail(eff)
```


### Startdepth instead of AVG.DEPTH

```{r Create AVG.DEPTH}
### Find STARTDEPTH and ENDDEPTH Variables

head(eff[,"startdepth"])

### Average STARTDEPTH and ENDDEPTH and save as AVG.DEPTH

#eff$AVG.DEPTH <- apply(eff[,c(8,12)], 1, FUN=mean) 

#range(eff$AVG.DEPTH, na.rm = TRUE)
```

### Month
```{r Create Month Variable }

head(eff$start_gmt)

str(eff$start_gmt)
### Format START_GMT as Date

eff$start_gmt <- strptime(eff$start_gmt, format = "%m/%d/%Y")

str(eff$start_gmt)

eff$month <- format.Date(eff$start_gmt, format = "%b")

str(eff$month)

unique(eff$month)
```


### Distance to shore

```{r Load packages needed to create distance to shore variable, eval=FALSE}
require(rgdal)   # for readOGR(...); loads package sp as well
require(rgeos)   # for gDistance(...)


require(parallel) # for detect cores
require(foreach)   # for foreach(...)
require(snow)      # for makeCluster(...)
require(doSNOW)    # for resisterDoSNOW(...)
```


```{r Distance to Shore Variable, eval=FALSE}
eff$Long <- eff$startlon
eff$Lat <- eff$startlat

head(eff)
str(eff)

wgs.84    <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
mollweide <- "+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
sp.points <- SpatialPoints(eff[,c("Long","Lat")], proj4string=CRS(wgs.84))

path <- "shape-file/ne_10m_coastline/ne_10m_coastline.shp"

coast  <- rgdal::readOGR(dsn = path,layer="ne_10m_coastline",p4s=wgs.84)

coast.moll <- spTransform(coast,CRS(mollweide))

point.moll <- spTransform(sp.points,CRS(mollweide))

no_cores <- detectCores()

cl <- makeCluster(no_cores,type="SOCK")  # create a 4-processor cluster
registerDoSNOW(cl)                # register the cluster

get.dist.parallel <- function(n) {
  foreach(i=1:n, .combine=c, .packages="rgeos", .inorder=TRUE, 
          .export=c("point.moll","coast.moll")) %dopar% gDistance(point.moll[i],coast.moll)
}

eff$Dis.to.SHORE <- get.dist.parallel(length(sp.points))

eff$Dis.to.SHORE <- eff$Dis.to.SHORE/1000

head(eff)
tail(eff)
str(eff)

stopCluster(cl)
```


```{r Plot points and shoreline, echo = FALSE}

gulf.shape <- "shape-file/Shape/stateshigh.shp"
gulf.shape <- maptools::readShapePoly(gulf.shape)

plot(eff$Long, eff$Lat,
     xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
     xlab ="Longitude", ylab = "Latitude",
     pch = 19)
par(new=T)
sp::plot(gulf.shape, add= T,
         xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
         col = "gray")

```


### Create Species, Sex, Maturity, and common name variables


```{r Create Species Sex and Maturity columns, eval=FALSE}

###write.csv(eff,file = "eff.csv", row.names = FALSE)
#eff <- read.csv("eff.csv") ### bring in eff.csv

str(eff)


  red.df <- eff %>% ### create reduced data frame
    select(year, month, startlat, startlon, start_gmt, 
           startdepth, tempbotm, fluorobotm, turbbotm, 
           oxybotm, salbotm, bottype4, Dis.to.SHORE, TAXON, CPUE,Adj.CPUE)
  
str(red.df)
tail(red.df)


red.df$TAXON <- as.character(red.df$TAXON) ### make TAXON variable character so it can be supplied to strsplit()

split_TAXON <- strsplit(red.df$TAXON, "_4_") ### split TAXON variable in tspecies and Sex Maturity segments seperated by _4_

    ### Check everything is good

split_TAXON[[1]][2]
red.df$TAXON[1]

split_TAXON[[5]][2]
red.df$TAXON[5]

split_TAXON[[1]][1]


str(split_TAXON)

### Create empty species vector
species <- numeric(length(split_TAXON))

for(i in 1:length(split_TAXON)){
  
  species[i] <- split_TAXON[[i]][1] ### fill in empty species vector with species from first component of split_TAXON list
  
  split_TAXON[[i]] <- split_TAXON[[i]][2] ### create a new list with just Sex and Maturity
  
}

### make split_TAXON list a vector so it can be supplied to strsplt()
split_TAXON_vec <- unlist(split_TAXON)

### separate Sex and Maturity
split_sex_mat <- strsplit(split_TAXON_vec, split = "")

str(split_sex_mat)


### create emplty sex and maturity vectors
sex <- numeric(length(split_sex_mat))

maturity <- numeric(length(split_sex_mat))

### fill in sex and maturity
for(i in 1:length(split_sex_mat)){
  
  sex[i] <- unlist(split_sex_mat[[i]][1])

  maturity[i] <- unlist(split_sex_mat[[i]][2])
  
}
### check everything is good
head(sex)
head(maturity)
head(red.df$TAXON)


### add species, sex, and maturity variables to red.df
red.df$species <- species
red.df$sex <- sex 
red.df$maturity <- maturity

### check
str(red.df)
tail(red.df) ### good


### rename species with common names

unique(red.df$species) %>% sort() ### interesting only 7 species
### No silky this makes sense

red.df$common <- numeric(nrow(red.df))


for(i in 1:nrow(red.df)){
  
  if( red.df$species[i] == "C_ACR" ){ red.df$common[i] <- "Blacknose" }
  if( red.df$species[i] == "C_BRE" ){ red.df$common[i] <- "Spinner" }
  if( red.df$species[i] == "C_LEU" ){ red.df$common[i] <- "Bull" }
  if( red.df$species[i] == "C_LIM" ){ red.df$common[i] <- "Blacktip" }
  if( red.df$species[i] == "C_PLU" ){ red.df$common[i] <- "Sandbar" }
  if( red.df$species[i] == "G_CUV" ){ red.df$common[i] <- "Tiger" }
  if( red.df$species[i] == "R_TER" ){ red.df$common[i] <- "Sharpnose" }
  
}




### check
str(red.df)
tail(red.df)

```

### Create Presence Absence Variable

```{r Create pres variable, eval=FALSE}
### Add presence absence variable
red.df$pres <- numeric(nrow(red.df))

for(i in 1:nrow(red.df)){
    
    if(red.df$CPUE[i] > 0){
      
      red.df$pres[i] <- 1
      
    } else if(red.df$CPUE[i] == 0){
      
      red.df$pres[i] <- 0
      
    } else{
      
      red.df$pres[i] <- "NA"
      
    }
}

### check
str(red.df)
tail(red.df)


```


### Saving changes to CPUE2.csv 

```{r Create CPUE2.csv, eval=FALSE}

#8-15-18#write_csv_fn( red.df, file = "data/raw-data/CPUE2.csv", row.names = FALSE, proj)

```


## QA/QC ##


### 1. Load CPUE2.csv data, Extract CPUE for all species and save in a list called sp.df


```{r Load eff2 data, }

eff2 <- read_csv_fn( "data/raw-data/CPUE2.csv", proj)

str(eff2)
headtail(eff2)

Species_Vec <- levels(eff2$common)


sp.lst <- list(blacknose =  subset(eff2, common == Species_Vec[1]),
              
              blacktip = subset(eff2, common == Species_Vec[2]),
              
              bull = subset(eff2, common == Species_Vec[3]),
              
              sandbar = subset(eff2, common == Species_Vec[4]),
              
              sharpnose = subset(eff2, common == Species_Vec[5]),
              
              spinner = subset(eff2, common == Species_Vec[6]),
              
              tiger = subset(eff2, common == Species_Vec[7]))

str(sp.lst[[1]])
head(sp.lst[[5]])


```


### 2. Plot CPUE for all Species vs all Explanatory variables


```{r Plot CPUE vs all Variables, echo=FALSE}

for(i in 1:length(sp.lst)){
  
  oldpar <- par(mfrow=c(3,4), mar=c(5,4,2,1), oma=c(1,0,3,1))
  
  plot(CPUE ~ year,
       data = sp.lst[[i]])
  mtext(paste0("r = ",
               round(cor(sp.lst[[i]]$year,
                         sp.lst[[i]]$CPUE ),
                     3) ),
        side=3,line=0)
  
  plot(CPUE ~ startdepth,
       data = sp.lst[[i]])
  mtext(paste0("r = ",
               round(cor(sp.lst[[i]]$startdepth,
                         sp.lst[[i]]$CPUE,
                         use = "complete.obs"),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ salbotm,
       data = sp.lst[[i]])
  mtext(paste0("r = ",
               round(cor(sp.lst[[i]]$salbotm,
                         sp.lst[[i]]$CPUE, 
                         use = "complete.obs"),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ tempbotm,
       data = sp.lst[[i]])
  mtext(paste0("r = ",
               round(cor(sp.lst[[i]]$tempbotm,
                         sp.lst[[i]]$CPUE, 
                         use = "complete.obs"),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ fluorobotm,
       data = sp.lst[[i]])
  mtext(paste0("r = ",
               round(cor(sp.lst[[i]]$fluorobotm, 
                         sp.lst[[i]]$CPUE, 
                         use = "complete.obs"),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ turbbotm,
       data = sp.lst[[i]])
  mtext(paste0("r = ",
               round(cor(sp.lst[[i]]$turbbotm,
                         sp.lst[[i]]$CPUE, 
                         use = "complete.obs"),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ oxybotm,
       data = sp.lst[[i]])
  mtext(paste0("r = ",
               round(cor(sp.lst[[i]]$oxybotm,
                         sp.lst[[i]]$CPUE, 
                         use = "complete.obs"),
                     3) ),
        side=3,line=0)
  
  plot(CPUE ~ bottype4,
       data = sp.lst[[i]],
       xlab="", las=2)
  
  plot(CPUE ~ Dis.to.SHORE,
       data = sp.lst[[i]],
       las=2)
    mtext(paste0("r = ",
               round(cor(sp.lst[[i]]$Dis.to.SHORE,
                         sp.lst[[i]]$CPUE,
                         use = "complete.obs"),
                     3)),
        side=3,line=0)

  plot(CPUE ~ startlat,
       data = sp.lst[[i]])
  mtext(paste0("r = ",
               round(cor(sp.lst[[i]]$startlat,
                         sp.lst[[i]]$CPUE ),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ startlon,
       data = sp.lst[[i]])
  mtext(paste0("r = ",
               round(cor(sp.lst[[i]]$startlon,
                         sp.lst[[i]]$CPUE ),
                     3)),
        side=3,line=0)
  
  ### Add Species common name to Title
  mtext(names(sp.lst[i]), 
        side=3, 
        line=0.65, 
        outer=TRUE, 
        cex=2, 
        font=2)
  
  par(oldpar)
}

```

#### Lat Lon

```{r, echo=FALSE}
require(rgdal)   # for readOGR(...); loads package sp as well
require(rgeos)   # for gDistance(...)
gulf.shape <- "shape-file/Shape/stateshigh.shp"
gulf.shape <- maptools::readShapePoly(gulf.shape)

### Lat Lon
for(i in 1:length(sp.lst)){
    oldpar <- par(mfrow=c(2,2), mar=c(5,4,2,1), oma=c(1,0,3,1))
    
  plot(startlat ~ startlon, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "A" & sp.lst[[i]]$pres ==1,],
         xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
       main = "Female Adult" )
  
  sp::plot(gulf.shape, add= T,
         xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
         col = "gray")
  
  
  plot(startlat ~ startlon, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "J" & sp.lst[[i]]$pres ==1,],
         xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
       main = "Female Juvenile" )
  
  sp::plot(gulf.shape, add= T,
         xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
         col = "gray")
  
  
  plot(startlat ~ startlon, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "A" & sp.lst[[i]]$pres ==1,],
         xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
       main = "Male Adult" )
  
  sp::plot(gulf.shape, add= T,
         xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
         col = "gray")
  
  
  plot(startlat ~ startlon, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "J" & sp.lst[[i]]$pres ==1,],
         xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
       main = "Male Juvenile")
  
  sp::plot(gulf.shape, add= T,
         xlim = c(-97.5, -80.7), ylim = c(25, 30.5),
         col = "gray")
  
 
    mtext(names(sp.lst[i]), 
        side=3, 
        line=0.65, 
        outer=TRUE, 
        cex=2, 
        font=2)
 par(oldpar)
    
}
```

#### Temp

```{r, echo=FALSE}
### Temp
for(i in 1:length(sp.lst)){
    oldpar <- par(mfrow=c(2,2), mar=c(5,4,2,1), oma=c(1,0,3,1))
    
  plot(CPUE ~ tempbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "A",],
       main = "Female Adult" )
  plot(CPUE ~ tempbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "J",],
       main = "Female Juvenile" )
  plot(CPUE ~ tempbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "A",],
       main = "Male Adult" )
  plot(CPUE ~ tempbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "J",],
       main = "Male Juvenile")
 
    mtext(names(sp.lst[i]), 
        side=3, 
        line=0.65, 
        outer=TRUE, 
        cex=2, 
        font=2)
 par(oldpar)
    
}
```

#### Fluorobotm

```{r, echo=FALSE}
### Fluorobotm

for(i in 1:length(sp.lst)){
    oldpar <- par(mfrow=c(2,2), mar=c(5,4,2,1), oma=c(1,0,3,1))
    
  plot(CPUE ~ fluorobotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "A",],
       main = "Female Adult" )
  plot(CPUE ~ fluorobotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "J",],
       main = "Female Juvenile" )
  plot(CPUE ~ fluorobotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "A",],
       main = "Male Adult" )
  plot(CPUE ~ fluorobotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "J",],
       main = "Male Juvenile")
 
    mtext(names(sp.lst[i]), 
        side=3, 
        line=0.65, 
        outer=TRUE, 
        cex=2, 
        font=2)
 par(oldpar)
    
}
```

#### Turbidity

```{r, echo=FALSE}
###turbbotm
for(i in 1:length(sp.lst)){
    oldpar <- par(mfrow=c(2,2), mar=c(5,4,2,1), oma=c(1,0,3,1))
    
  plot(CPUE ~ turbbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "A",],
       main = "Female Adult" )
  plot(CPUE ~ turbbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "J",],
       main = "Female Juvenile" )
  plot(CPUE ~ turbbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "A",],
       main = "Male Adult" )
  plot(CPUE ~ turbbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "J",],
       main = "Male Juvenile")
 
    mtext(names(sp.lst[i]), 
        side=3, 
        line=0.65, 
        outer=TRUE, 
        cex=2, 
        font=2)
 par(oldpar)
    
}
```

#### Oxybotm

```{r, echo=FALSE}
### oxybotm
for(i in 1:length(sp.lst)){
    oldpar <- par(mfrow=c(2,2), mar=c(5,4,2,1), oma=c(1,0,3,1))
    
  plot(CPUE ~ oxybotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "A",],
       main = "Female Adult" )
  plot(CPUE ~ oxybotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "J",],
       main = "Female Juvenile" )
  plot(CPUE ~ oxybotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "A",],
       main = "Male Adult" )
  plot(CPUE ~ oxybotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "J",],
       main = "Male Juvenile")
 
    mtext(names(sp.lst[i]), 
        side=3, 
        line=0.65, 
        outer=TRUE, 
        cex=2, 
        font=2)
 par(oldpar)
    
}
```

#### Salinity

```{r, echo=FALSE}  
### Salinity
for(i in 1:length(sp.lst)){
    oldpar <- par(mfrow=c(2,2), mar=c(5,4,2,1), oma=c(1,0,3,1))
    
  plot(CPUE ~ salbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "A",],
       main = "Female Adult" )
  plot(CPUE ~ salbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "J",],
       main = "Female Juvenile" )
  plot(CPUE ~ salbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "A",],
       main = "Male Adult" )
  plot(CPUE ~ salbotm, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "J",],
       main = "Male Juvenile")
 
    mtext(names(sp.lst[i]), 
        side=3, 
        line=0.65, 
        outer=TRUE, 
        cex=2, 
        font=2)
 par(oldpar)
    
}

```

#### Distance to shore

```{r, echo=FALSE}
### Dis.to.SHORE

for(i in 1:length(sp.lst)){
    oldpar <- par(mfrow=c(2,2), mar=c(5,4,2,1), oma=c(1,0,3,1))
    
  plot(CPUE ~ Dis.to.SHORE, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "A",],
       main = "Female Adult" )
  plot(CPUE ~ Dis.to.SHORE, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="F" & sp.lst[[i]]$maturity == "J",],
       main = "Female Juvenile" )
  plot(CPUE ~ Dis.to.SHORE, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "A",],
       main = "Male Adult" )
  plot(CPUE ~ Dis.to.SHORE, 
       data =sp.lst[[i]][sp.lst[[i]]$sex=="M" & sp.lst[[i]]$maturity == "J",],
       main = "Male Juvenile")
 
    mtext(names(sp.lst[i]), 
        side=3, 
        line=0.65, 
        outer=TRUE, 
        cex=2, 
        font=2)
 par(oldpar)
    
}

```

**Blacknose**

No *startdepth* over 100.
*salbotm*  greater than 40 looks like 1 outlier at 0.

**Blacktip**

**Bull**

*Dis.to.SHORE* 

**Sandbar**

**Sharpnose**

**Spinner**

Juveniles may occupy larger temperature range than adults

**Tiger**

 Not enough data in Adult to make separate maturity. Seems to be a lack of unique values CPUE is clustered around whole numbers.

### 3. Identify outliers

```{r Explanatory variable range}
var_vec <- names(sp.lst[[1]][,c(1,3,4,6:13,15)])

eff2 %>% select(var_vec) %>% summary()


range(eff2$tempbotm, na.rm=TRUE) # 8.6 to 31.8 C

range(eff2$startdepth, na.rm=TRUE)  # 9 to 375

range(eff2$fluorobotm, na.rm=TRUE) # 0 to 62.8

range(eff2$turbbotm, na.rm=TRUE) # 0 to 122.4

range(eff2$oxybotm, na.rm=TRUE) # 0 to 10.7

range(eff2$salbotm, na.rm=TRUE) # 17.9 to 48.8

range(eff2$Dis.to.SHORE, na.rm=TRUE) # 2.15 to 236.5 km
```

#### Lat Lon QA/QC


```{r Lat Lon QAQC, echo=FALSE}
par(mfrow=c(1,1))
plot(eff2$startlon, eff2$startlat)
```
All looks good here.

#### Startdepth QA/AC
```{r depth QAQC, results='hide', fig.keep='last'}
range(eff2$startdepth, na.rm=TRUE) # 9 to 375

plot(CPUE ~ startdepth,
     data = eff2)

```

```{r depth Nas, eval=FALSE, echo=FALSE,results='hide',fig.keep='last'}
(depth.NA <- which(is.na(eff2$startdepth) == TRUE))

length(depth.NA)

(depth.NA.percent.data <- length(depth.NA)/nrow(eff2) * 100)

table(eff2$year[c(depth.NA)])

hist(eff2$year[c(depth.NA)],
     xaxt = "n",
     labels = TRUE,
     ylab = "number of NAs", 
     xlab = "Year",
     main = paste0( "startdepth NAs represent ", eval(round( length(depth.NA)/nrow(eff2) * 100 , 2)), " % of the Data"))

axis(1, at = seq(2001, 2017,1))
```

  I don't think there are any outliers here. Very little positive catch past about 160 m, however, there is no way I should remove those zeros. There are no NAs in startdepth.

#### Temperature QA/QC

**Temp** Reasonable temps are from 50 F (10 C) in winter to 88 F (31 C) summer [https://www.nodc.noaa.gov/dsdt/cwtg/all_meanT.html]

```{r Temp QAQC,results='hide',fig.keep='last'}
unique(eff2$month, na.rm=TRUE) # July to november
range(eff2$tempbotm, na.rm=TRUE) # 8.6 to 31.8 C
# Range looks pretty reasonable

rm.temp <- which(eff2$tempbotm < 9)

par(mfrow = c(1,1))
plot(CPUE ~ tempbotm,
     data = eff2[-c(rm.temp),],
     xlim = c(8,33), ylim = c(0,65),
     pch = 19,
     col = rgb(0,0,0, 0.15),
     main = "",
     bty = "n")

abline(v = 9, lty = 3, col = "green")

par(new = T)

plot(CPUE ~ tempbotm,
     data = eff2[c(rm.temp),],
     xlim = c(8,33), ylim = c(0,65),
     xaxt = "n", yaxt = "n",
     xlab = "", ylab = "",
     pch = 19,
     col = rgb(1,0,0, 0.15),
     main = paste0(expression("n = "), eval(length(rm.temp)/49)," Station(s) ", "(or " , eval(length(rm.temp)), " lines of data)"),
     bty = "n")
```

```{r Temp Nas, echo=FALSE,results='hide',fig.keep='last'}
(temp.NA <- which(is.na(eff2$tempbotm) == TRUE))

length(temp.NA)

(temp.NA.percent.data <- length(temp.NA)/nrow(eff2) * 100)

table(eff2$year[c(temp.NA)])

hist(eff2$year[c(temp.NA)],
     xaxt = "n",
     labels = TRUE,
     ylab = "number of NAs", 
     xlab = "Year",
     main = paste0( "tempbotm NAs represent ", eval(round( length(temp.NA)/nrow(eff2) * 100 , 2)), " % of the Data"))

axis(1, at = seq(2001, 2017,1))
```


I will remove temperatures $less \ than \ 9 \ ^\circ{C}$. This comes out to be $n =$ `r length(rm.temp)/49` station(s). NAs in temp account for `r round( length(temp.NA)/nrow(eff2) * 100 , 2)` $\%$ of the data.


#### Fluorobotm QA/QC

**Fluorobotom** IDK

```{r Fluorobotm QAQC,results='hide',fig.keep='last'}
range(eff2$fluorobotm, na.rm=TRUE) # 0 to 62.8

rm.fluo <- which(eff2$fluorobotm == 0 | eff2$fluorobotm > 26.5)

par(mfrow = c(1,1))
plot(CPUE ~ fluorobotm,
     data = eff2[-c(rm.fluo),],
     xlim = c(0,63), ylim = c(0,70),
     pch = 19,
     col = rgb(0,0,0, 0.15),
     main = "",
     bty = "n")

abline(v = 0, lty = 3, col = "green")

abline(v = 13, lty = 2, col = "red")

abline(v = 20, lty = 2, col = "red")

abline(v = 26.5, lty = 3, col = "green")


par(new = T)

plot(CPUE ~ fluorobotm,
     data = eff2[c(rm.fluo),],
     xlim = c(8,33), ylim = c(0,65),
     xaxt = "n", yaxt = "n",
     xlab = "", ylab = "",
     pch = 19,
     col = rgb(1,0,0, 0.15),
     main = paste0(expression("n = "), eval(length(rm.fluo)/49)," Station(s) ", "(or " , eval(length(rm.fluo)), " lines of Data)"),
     bty = "n")
```

```{r Fluo NAs,results='hide',fig.keep='last'}
(fluo.NA <- which(is.na(eff2$fluorobotm) == TRUE))

length(fluo.NA)

(fluo.NA.percent.data <- length(fluo.NA)/nrow(eff2) * 100)

table(eff2$year[c(fluo.NA)])

hist(eff2$year[c(fluo.NA)],
     xaxt = "n",
     labels = TRUE,
     ylab = "number of NAs", 
     xlab = "Year",
     main = paste0( "fluorobotm NAs represent ", eval(round( length(fluo.NA)/nrow(eff2) * 100 , 2)), " % of the Data"))

axis(1, at = seq(2001, 2017,1))

## n divided by 49 because of 49 levels of data. 
```

I will not remove any outliers from this because the NAs make up `r round( length(fluo.NA)/nrow(eff2) * 100 , 2)` $\%$ of the data frame. I will **not** be using this as an explanatory variable.

#### Turbbotm QA/QC

**Turbbotm** 

```{r Turbbotm QAQC,results='hide',fig.keep='last'}

 ### TURBBOTM and FLUOROBOTM are not used as explanitory variables so there is no need to remove outliers

plot(CPUE ~ turbbotm,
     xlim = c(0,125), ylim = c(0,70),
     data = eff2)

abline(v = 0, lty = 2, col = "red")
abline(v = 100, lty = 2, col = "red")
abline(v = 104, lty = 2, col = "red")

range(eff2$turbbotm , na.rm=T) # 0.0000 122.3585

#(rm.Turb <- which(eff2$turbbotm > 100 | eff2$turbbotm <= 0)) # 27 individuals and 1323 lines
#(rm.Turb <- which(eff2$turbbotm > 100 )) # 19 individuals  
#(rm.Turb <- which(eff2$turbbotm > 104 )) # 5 individuals
rm.Turb <- which(eff2$turbbotm > 110 ) # 1 individual

(n.rm.turb <- length(rm.Turb)/49) ### 1 individual


plot(CPUE ~ turbbotm,
     xlim = c(0,125), ylim = c(0,70),
     data = eff2[-c(rm.Turb),],
     pch = 19,
     col = rgb(0,0,0, 0.25))

#abline(v = 0, lty = 3, col = "green")
abline(v = 100, lty = 2, col = "red")

abline(v = 104, lty = 2, col = "red")
abline(v = 110, lty = 3, col = "green")

par(new = T)

plot(CPUE ~ turbbotm,
     data = eff2[c(rm.Turb),],
     xlim = c(0,125), ylim = c(0,70),
     xlab = "", ylab = "",
     yaxt = "n", xaxt = "n",
     pch = 19,
     col = rgb(1,0,0, 0.25),
     main = paste0(expression("n = "), eval(length(rm.Turb)/49)," Station(s) ", "(or " , eval(length(rm.Turb)), " lines of Data)"))

```

```{r Turb Nas, echo=FALSE,results='hide',fig.keep='last'}
(turb.NA <- which(is.na(eff2$turbbotm) == TRUE))

length(turb.NA)

(turb.NA.percent.data <- length(turb.NA)/nrow(eff2) * 100)

table(eff2$year[c(turb.NA)])

hist(eff2$year[c(turb.NA)],
     xaxt = "n",
     labels = TRUE,
     ylab = "number of NAs", 
     xlab = "Year",
     main = paste0( "turbbotm NAs represent ", eval(round( length(turb.NA)/nrow(eff2) * 100 , 2)), " % of the Data"))

axis(1, at = seq(2001, 2017,1))

```

NAs in Turbbotm represent `r round( length(turb.NA)/nrow(eff2) * 100 , 2)` $\%$ of the data. This seems like a lot but I will include this as an explanatory variable. I am only removing turbidity $greater \ than \ 110$ which results in the removal of $1 \ station$ (if I remove turbidity greater than 104 this removes 5 stations and above 100 removes 27 stations).


#### Oxybotm QA/QC

**Oxybotm** Hypoxia near Louisiana coast where DO is less than 2 ppm [https://toxics.usgs.gov/hypoxia/hypoxic_zone.html], 
Ranges 0 to 8 (Summer) [https://www.ncddc.noaa.gov/hypoxia/products/2010/]

```{r Oxybotm QAQC,results='hide',fig.keep='last'}

#eff2[c(rm.Sal),]

### oxybotm

range(eff2$oxybotm, na.rm = TRUE) # 0 to 10.7

rm.oxy <- which(eff2$oxybotm == 0)

#eff2[c(oxy),]

plot(CPUE ~ oxybotm,
     data = eff2[-c(rm.oxy),],
     xlim = c(0,11), ylim = c(0,70),
     pch = 19,
     col = rgb(0,0,0, 0.15),
     bty = "n")

par(new = T)
plot(CPUE ~ oxybotm,
     data = eff2[c(rm.oxy),],
     xlim = c(0,11), ylim = c(0,70),
     xlab = "", ylab = "",
     xaxt = "n", yaxt = "n",
     pch = 19,
     col = rgb(1,0,0, 0.25),
     main = paste0(expression("n = "), eval(length(rm.oxy)/49)," Station(s) ", "(or " , eval(length(rm.oxy)), " lines of Data)"),
     bty = "n")

#abline(v = 9, col = "red", lty = 2)
#abline(v = 10.5, col = "red", lty = 2)


#(rm.Oxy <- which(eff2$oxybotm > 12 | eff2$oxybotm == 0)) ### 99 100 338 339 411 625 652 823 824 

```


```{r oxybotm Nas, echo=FALSE,results='hide',fig.keep='last'}
(oxy.NA <- which(is.na(eff2$oxybotm) == TRUE))

length(oxy.NA)

(oxy.NA.percent.data <- length(oxy.NA)/nrow(eff2) * 100)

table(eff2$year[c(oxy.NA)])

hist(eff2$year[c(oxy.NA)],
     xaxt = "n",
     labels = TRUE,
     ylab = "number of NAs", 
     xlab = "Year",
     main = paste0( "oxybotm NAs represent ", eval(round( length(oxy.NA)/nrow(eff2) * 100 , 2)), " % of the Data"))

axis(1, at = seq(2001, 2017,1))

```

I'm not going to remove any *oxybotm* these seem fairly reasonable even though there are some in hypoxic waters. NAs from oxybotm represent `r round( length(oxy.NA)/nrow(eff2) * 100 , 2)` $\%$ of the data.

#### Salinity QA/QC

**Salinity** Ranges between 32 to 36.5 (WINTER) and 31 to 36.5 (SUMMER) on average in the northern GoM. [https://gulfatlas.noaa.gov/catalog/products/physical/seawater-salinity/index.html]

```{r Salinity QAQC, eval=TRUE,results='hide',fig.keep='last'}
range(eff2$salbotm, na.rm = TRUE) # 17.9 to 48.8

      ## was less than 15
#(rm.Sal <- which(eff2$salbotm > 40 | eff2$salbotm < 20)) ### 507  932 2705 2770 2771 2941 2979
rm.Sal <- which(eff2$salbotm > 38 | eff2$salbotm < 23)

par(mfrow = c(1,1))
plot(CPUE ~ salbotm,
     data = eff2[-c(rm.Sal),],
     xlim = c(15, 50), ylim = c(0,70),
     pch = 19,
     col = rgb(0,0,0, 0.15),
     main = "",
     bty = "n")

par(new = T)

plot(CPUE ~ jitter(salbotm, amount = 0.5),
     data = eff2[c(rm.Sal),],
     xlim = c(15, 50), ylim = c(0,70),
     xlab = "", ylab = "",
     xaxt = "n", yaxt = "n",
     pch = 19,
     col = rgb(1,0,0, 0.15),
     main = paste0(expression("n = "), eval(length(rm.Sal)/49)," Station(s) ", "(or " , eval(length(rm.Sal)), " lines of Data)"),
     bty = "n" )

abline(v = 40, col = "red", lty = 2)
abline(v = 20, col = "red", lty = 2)

abline(v = 38, col = "green", lty = 3)
abline(v = 23, col = "green", lty = 3)

#text(x= eff2$salbotm[c(rm.Sal)], y = eff2$CPUE[c(rm.Sal)] ,
#      labels = as.character(round(eff2$salbotm[c(rm.Sal)],1)),
#     pos = 3)
```

```{r salbotm Nas, echo=FALSE,results='hide',fig.keep='last'}
(sal.NA <- which(is.na(eff2$salbotm) == TRUE))

length(sal.NA)

(sal.NA.percent.data <- length(sal.NA)/nrow(eff2) * 100)

table(eff2$year[c(sal.NA)])

hist(eff2$year[c(sal.NA)],
     xaxt = "n",
     labels = TRUE,
     ylab = "number of NAs", 
     xlab = "Year",
     main = paste0( "salbotm NAs represent ", eval(round( length(sal.NA)/nrow(eff2) * 100 , 2)), " % of the Data"))

axis(1, at = seq(2001, 2017,1))

```

I will remove salinity $less \ than \ 23$ and $greater \ than \ 38$ which will result in the removal of `r length(rm.Sal)/49` stations. NAs in Salinity account for `r round( length(sal.NA)/nrow(eff2) * 100 , 2)` $\%$ of the data.

### 4. remove outliers and create individual data frames for each species save as .csv file

```{r n to remove for QAQC}

#eff2[c(rm.Turb),]

#(rm.Fluo <-which(eff2$FLUOROBOTM > 30)) ### 1536, 1802, 2230, 2660, 2704

(n.lines.rm <- length(rm.temp) + length(rm.Turb) + length(rm.Sal))

(n.rm <- (length(rm.temp) + length(rm.Turb) + length(rm.Sal))/49 ) ### individuals

```

```{r Create CPUE3.csv, eval = FALSE}


  ### round 1 ###rm.EndLon
rm1 <- c(rm.temp, rm.Turb, rm.Sal) %>%
   sort()

length(rm1)
length(unique(rm1))

nrow(eff2)

eff2 <- eff2[-c(rm1),]
######

nrow(eff2)

str(eff2)

#8-15-18#write_csv_fn( eff2, file = "data/raw-data/CPUE3.csv", row.names = FALSE, proj)
```


### 5. Load newly created .csv files and save to sp.df list

```{r load eff3}
eff3 <- read_csv_fn( "data/raw-data/CPUE3.csv", proj)
```

```{r Prep load data fn, eval=FALSE, include=FALSE}
x <- eff3

Species_Vec <- levels(x$common)



  Female <- vector("list", length = length(x))
  Male <- vector("list", length = length(x))
  
  
  
  Female <- list(blacknose =  filterD(x, common == Species_Vec[1], pres == 1, sex == "F"),
                                       
                                       blacktip = filterD(x, common == Species_Vec[2], pres == 1, sex == "F"),
              
                                       bull = filterD(x, common == Species_Vec[3], pres == 1, sex == "F"),
              
                                       sandbar = filterD(x, common == Species_Vec[4], pres == 1, sex == "F"),
              
                                       sharpnose = filterD(x, common == Species_Vec[5], pres == 1, sex == "F"),
              
                                       spinner = filterD(x, common == Species_Vec[6], pres == 1, sex == "F"),
              
                                       tiger = filterD(x, common == Species_Vec[7], pres == 1, sex == "F"))
  
  
  Male <- list(blacknose =  filterD(x, common == Species_Vec[1], pres == 1, sex == "M"),
                                     
                                     blacktip = filterD(x, common == Species_Vec[2], pres == 1, sex == "M"),
              
                                     bull = filterD(x, common == Species_Vec[3], pres == 1, sex == "M"),
              
                                     sandbar = filterD(x, common == Species_Vec[4], pres == 1, sex == "M"),
              
                                     sharpnose = filterD(x, common == Species_Vec[5], pres == 1, sex == "M"),
              
                                     spinner = filterD(x, common == Species_Vec[6], pres == 1, sex == "M"),
              
                                     tiger = filterD(x, common == Species_Vec[7], pres == 1, sex == "M"))

  tmp <- list(Female = Female,
                    Male = Male)
str(strat2$blacknose)



```

```{r Load data function}
load_data <- function(data = data, strata = 1){
  
  require(FSA)
  require(magrittr)
  
  Species_Vec <- levels(data$common)
  Female <- vector("list", length = length(data))
  Male <- vector("list", length = length(data))
  
  
  if(strata == 1){
    
  Female <- list(blacknose =  filterD(data, common == Species_Vec[1], sex == "F"),
                                       
                                       blacktip = filterD(data, common == Species_Vec[2], sex == "F"),
              
                                       bull = filterD(data, common == Species_Vec[3], sex == "F"),
              
                                       sandbar = filterD(data, common == Species_Vec[4], sex == "F"),
              
                                       sharpnose = filterD(data, common == Species_Vec[5], sex == "F"),
              
                                       spinner = filterD(data, common == Species_Vec[6], sex == "F"),
              
                                       tiger = filterD(data, common == Species_Vec[7], sex == "F"))
  
  
  Male <- list(blacknose =  filterD(data, common == Species_Vec[1], sex == "M"),
                                     
                                     blacktip = filterD(data, common == Species_Vec[2], sex == "M"),
              
                                     bull = filterD(data, common == Species_Vec[3], sex == "M"),
              
                                     sandbar = filterD(data, common == Species_Vec[4], sex == "M"),
              
                                     sharpnose = filterD(data, common == Species_Vec[5], sex == "M"),
              
                                     spinner = filterD(data, common == Species_Vec[6], sex == "M"),
              
                                     tiger = filterD(data, common == Species_Vec[7], sex == "M"))
  
    output <- list(Female = Female,
                 Male = Male)
    
  } else if(strata == 2){
    
  Female <- list(blacknose =  filterD(data, common == Species_Vec[1], pres == 1, sex == "F"),
                                       
                                       blacktip = filterD(data, common == Species_Vec[2], pres == 1, sex == "F"),
              
                                       bull = filterD(data, common == Species_Vec[3], pres == 1, sex == "F"),
              
                                       sandbar = filterD(data, common == Species_Vec[4], pres == 1, sex == "F"),
              
                                       sharpnose = filterD(data, common == Species_Vec[5], pres == 1, sex == "F"),
              
                                       spinner = filterD(data, common == Species_Vec[6], pres == 1, sex == "F"),
              
                                       tiger = filterD(data, common == Species_Vec[7], pres == 1, sex == "F"))
  
  
  Male <- list(blacknose =  filterD(data, common == Species_Vec[1], pres == 1, sex == "M"),
                                     
                                     blacktip = filterD(data, common == Species_Vec[2], pres == 1, sex == "M"),
              
                                     bull = filterD(data, common == Species_Vec[3], pres == 1, sex == "M"),
              
                                     sandbar = filterD(data, common == Species_Vec[4], pres == 1, sex == "M"),
              
                                     sharpnose = filterD(data, common == Species_Vec[5], pres == 1, sex == "M"),
              
                                     spinner = filterD(data, common == Species_Vec[6], pres == 1, sex == "M"),
              
                                     tiger = filterD(data, common == Species_Vec[7], pres == 1, sex == "M"))
  
  output <- list(Female = Female,
                 Male = Male)
    
  } else stop("Strata must equal either 1 or 2 !!!")
  
  return(output)
}



```


```{r test load data function}

test_strata1 <- load_data(data = eff3, strata = 1)

str(test_strata1$Female$blacknose)


test_strata2 <- load_data(data = eff3, strata = 2)

str(test_strata2$Female$blacknose)
str(test_strata2$Male$sharpnose)

### Mature Adults from strata 1

test_Adult_strata1 <- load_data(data = eff3[eff3$maturity == "A",]%>% droplevels(), strata = 1) 

str(test_Adult_strata1$Female$blacknose)

str(test_Adult_strata1$Male$blacknose)

str(test_Adult_strata1$Female$sharpnose)

str(test_Adult_strata1$Male$sharpnose)

### Good

```


### 6. make new cpue plots and make sure outliers are gone.

```{r}
fem <- test_strata1$Female
mal <- test_strata1$Male

str(fem$blacknose)
str(mal$blacknose)
```



```{r New Plot cpe vs all vars, echo=FALSE, eval=TRUE}

for(i in 1:length(fem)){
  
  oldpar <- par(mfrow=c(3,4), mar=c(5,4,2,1), oma=c(1,0,3,1))
  
  plot(CPUE ~ year,
       data = fem[[i]])
  mtext(paste0("r = ",
               round(cor(fem[[i]]$year,
                         fem[[i]]$CPUE ),
                     3) ),
        side=3,line=0)
  
  plot(CPUE ~ startdepth,
       data = fem[[i]])
  mtext(paste0("r = ",
               round(cor(fem[[i]]$startdepth,
                         fem[[i]]$CPUE,
                         use = "complete.obs"),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ salbotm,
       data = fem[[i]])
  mtext(paste0("r = ",
               round(cor(fem[[i]]$salbotm,
                         fem[[i]]$CPUE, 
                         use = "complete.obs"),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ tempbotm,
       data = fem[[i]])
  mtext(paste0("r = ",
               round(cor(fem[[i]]$tempbotm,
                         fem[[i]]$CPUE, 
                         use = "complete.obs"),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ fluorobotm,
       data = fem[[i]])
  mtext(paste0("r = ",
               round(cor(fem[[i]]$fluorobotm, 
                         fem[[i]]$CPUE, 
                         use = "complete.obs"),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ turbbotm,
       data = fem[[i]])
  mtext(paste0("r = ",
               round(cor(fem[[i]]$turbbotm,
                         fem[[i]]$CPUE, 
                         use = "complete.obs"),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ oxybotm,
       data = fem[[i]])
  mtext(paste0("r = ",
               round(cor(fem[[i]]$oxybotm,
                         fem[[i]]$CPUE, 
                         use = "complete.obs"),
                     3) ),
        side=3,line=0)
  
  plot(CPUE ~ bottype4,
       data = fem[[i]],
       xlab="", las=2)
  
  plot(CPUE ~ Dis.to.SHORE,
       data = fem[[i]],
       las=2)
    mtext(paste0("r = ",
               round(cor(fem[[i]]$Dis.to.SHORE,
                         fem[[i]]$CPUE,
                         use = "complete.obs"),
                     3)),
        side=3,line=0)

  plot(CPUE ~ startlat,
       data = fem[[i]])
  mtext(paste0("r = ",
               round(cor(fem[[i]]$startlat,
                         fem[[i]]$CPUE ),
                     3)),
        side=3,line=0)
  
  plot(CPUE ~ startlon,
       data = fem[[i]])
  mtext(paste0("r = ",
               round(cor(fem[[i]]$startlon,
                         fem[[i]]$CPUE ),
                     3)),
        side=3,line=0)
  
  ### Add Species common name to Title
  mtext(names(fem[i]), 
        side=3, 
        line=0.65, 
        outer=TRUE, 
        cex=2, 
        font=2)
  
  par(oldpar)
}
```


